%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% This script uses the nomenclature, formulations and solutions from:
%   M. Avillez and D. Arnas, "Osculating and Mean Asynchronous Relative Motion Approximations 
%   Under J2 and Atmospheric Drag", TODO
%
% Summary:
%   Converts a mean absolute state to an osculating absolute state.
%   Implements the solution from section V.B of the paper
%
% Inputs:
%   tt: argument of latitude at which to compute the osculating absolute state
%   mu: gravitational parameter
%   j2: J2 coefficient of the gravity model
%   R: Radius of the central planet
%   meanState: Mean absolute state -> see Note 1
%   k: Ballistic parameter of the satellite
%   rho: Atmospheric density acting on the satellite
%   expansionOrder: Order of the expansion to use (2 or 3)
%
% Outputs:
%   osculatingState: Osculating absolute state of the satellite -> see Note 1
%
% Note 1:
%   Mean absolute states: [bbM; xM; yM; pM; ooM; tM]
%   Osculating absolute states: [bb; x; y; p; oo; t]
%
% Authors: Miguel Avillez and David Arnas
% Created: August 2025
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function osculatingState = meanToOscAbsoluteState(tt, mu, j2, R, meanState, k, rho, expansionOrder)

  if expansionOrder == 2
    osculatingState = meanToOscAbsoluteStateOrder2(tt, mu, j2, R, meanState, k, rho);
  elseif expansionOrder == 3
    osculatingState = meanToOscAbsoluteStateOrder3(tt, mu, j2, R, meanState, k, rho);
  else
    error("Invalid expansion order")
  end

end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Function: meanToOscAbsoluteStateOrder2
%
%
% Summary:
%   Converts a mean absolute state to an osculating absolute state, based on a 2nd order expansion.
%
% Inputs:
%   tt: argument of latitude at which to compute the mean absolute state
%   mu: gravitational parameter
%   j2: J2 coefficient of the gravity model
%   R: Radius of the central planet
%   meanState: Mean absolute state -> see Note 1
%   k: Ballistic parameter of the satellite
%   rho: Atmospheric density acting on the satellite
%
% Outputs:
%   osculatingState: Osculating absolute state of the satellite -> see Note 1
%
% Note 1:
%   Mean absolute states: [bbM; xM; yM; pM; ooM; tM]
%   Osculating absolute states: [bb; x; y; p; oo; t]
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function osculatingState = meanToOscAbsoluteStateOrder2(tt, mu, j2, R, meanState, k, rho)

  % Extract individual elements of the mean state
  bbM = meanState(1);
  xM = meanState(2);
  yM = meanState(3);
  pM = meanState(4);
  ooM = meanState(5);
  tM = meanState(6);

  % Compute osculating elements
  bb = bbM+(1/32).*bbM.^5.*j2.*((-1)+bbM.^2.*pM.^2).*(32.*j2.*xM.*cos(tt) ...
    .^3+6.*(4+(-3).*bbM.^4.*j2+3.*bbM.^6.*j2.*pM.^2).*cos(2.*tt)+3.* ...
    bbM.^4.*j2.*((-5)+11.*bbM.^2.*pM.^2).*cos(4.*tt)+(-32).*j2.*yM.* ...
    sin(tt).^3);
  x = xM+(3/16).*bbM.^4.*((-2)+(-3).*bbM.^4.*j2+2.*bbM.^2.*(5+3.* ...
    bbM.^4.*j2).*pM.^2+21.*bbM.^8.*j2.*pM.^4).*cos(tt)+(-1).*bbM.^(-2) ...
    .*j2.^(-1).*k.*R.*rho.*sin(tt)+(1/32).*bbM.^4.*((-1).*((-1)+ ...
    bbM.^2.*pM.^2).*((28+(-43).*bbM.^4.*j2+86.*bbM.^6.*j2.*pM.^2).* ...
    cos(3.*tt)+3.*j2.*(6.*xM.*cos(4.*tt)+bbM.^4.*((-1)+8.*bbM.^2.* ...
    pM.^2).*cos(5.*tt)))+48.*j2.*((-1)+2.*bbM.^2.*pM.^2).*yM.*sin(2.* ...
    tt)+6.*j2.*((-4).*((-2)+bbM.^2.*pM.^2).*xM.*cos(2.*tt)+(-3).*((-1) ...
    +bbM.^2.*pM.^2).*yM.*sin(4.*tt)));
  y = yM+bbM.^(-2).*j2.^(-1).*k.*R.*rho.*cos(tt)+(-1/32).*bbM.^4.*(2.*( ...
    4+5.*bbM.^4.*j2+bbM.^2.*((-28)+33.*bbM.^4.*j2).*pM.^2+(-110).* ...
    bbM.^8.*j2.*pM.^4+6.*j2.*((-1)+bbM.^2.*pM.^2).*xM.*(7.*cos(tt)+3.* ...
    cos(3.*tt))).*sin(tt)+6.*j2.*((-1)+bbM.^2.*pM.^2).*cos(4.*tt).*(( ...
    -3).*yM+bbM.^4.*((-1)+8.*bbM.^2.*pM.^2).*sin(tt))+4.*cos(2.*tt).*( ...
    6.*j2.*((-3)+4.*bbM.^2.*pM.^2).*yM+((-1)+bbM.^2.*pM.^2).*(14+(-20) ...
    .*bbM.^4.*j2+43.*bbM.^6.*j2.*pM.^2).*sin(tt)));
  p = pM;
  oo = ooM+(1/16).*bbM.^5.*j2.*pM.*(36.*j2.*yM.*cos(tt)+(-4).*j2.*(yM.* ...
    cos(3.*tt)+4.*xM.*sin(tt).^3)+3.*(4+7.*bbM.^4.*j2+(-13).*bbM.^6.* ...
    j2.*pM.^2+bbM.^4.*j2.*((-5)+8.*bbM.^2.*pM.^2).*cos(2.*tt)).*sin( ...
    2.*tt));
  t = (1/64).*bbM.^(-5).*mu.^(-1/2).*(16.*(k.*pi.^2.*R.^(5/2).*rho+4.* ...
    bbM.^5.*mu.^(1/2).*tM)+bbM.^2.*j2.*R.^(3/2).*(32.*(4+9.*bbM.^4.* ...
    j2+(-27).*bbM.^6.*j2.*pM.^2).*yM.*cos(tt)+(-96).*j2.*xM.*yM.*cos( ...
    2.*tt)+8.*bbM.^4.*j2.*((-1)+5.*bbM.^2.*pM.^2).*yM.*cos(3.*tt)+64.* ...
    ((-2)+(-3).*bbM.^4.*j2+12.*bbM.^6.*j2.*pM.^2).*xM.*sin(tt)+2.*(( ...
    -4).*bbM.^4+bbM.^8.*j2+28.*bbM.^6.*pM.^2+72.*bbM.^10.*j2.*pM.^2+( ...
    -181).*bbM.^12.*j2.*pM.^4+24.*j2.*(xM+(-1).*yM).*(xM+yM)).*sin(2.* ...
    tt)+8.*bbM.^4.*j2.*(1+(-5).*bbM.^2.*pM.^2).*xM.*sin(3.*tt)+3.* ...
    bbM.^8.*j2.*(1+(-17).*bbM.^2.*pM.^2+22.*bbM.^4.*pM.^4).*sin(4.*tt) ...
    ));

  % Concatenate the elements of the osculating state
  osculatingState = [bb; x; y; p; oo; t];

end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Function: meanToOscAbsoluteStateOrder2
%
%
% Summary:
%   Converts a mean absolute state to an osculating absolute state, based on a 3rd order expansion.
%
% Inputs:
%   tt: argument of latitude at which to compute the mean absolute state
%   mu: gravitational parameter
%   j2: J2 coefficient of the gravity model
%   R: Radius of the central planet
%   meanState: Mean absolute state -> see Note 1
%   k: Ballistic parameter of the satellite
%   rho: Atmospheric density acting on the satellite
%
% Outputs:
%   osculatingState: Osculating absolute state of the satellite -> see Note 1
%
% Note 1:
%   Mean absolute states: [bbM; xM; yM; pM; ooM; tM]
%   Osculating absolute states: [bb; x; y; p; oo; t]
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function osculatingState = meanToOscAbsoluteStateOrder3(tt, mu, j2, R, meanState, k, rho)

  % Extract individual elements of the mean state
  bbM = meanState(1);
  xM = meanState(2);
  yM = meanState(3);
  pM = meanState(4);
  ooM = meanState(5);
  tM = meanState(6);

  % Compute osculating elements
  bb = bbM+(1/256).*bbM.^(-1).*j2.*(4.*(3.*bbM.^6.*j2.*((-1)+bbM.^2.* ...
    pM.^2).*(16+(-37).*bbM.^4.*j2+5.*bbM.^6.*j2.*pM.^2).*xM+32.*k.*R.* ...
    rho.*yM).*cos(tt)+3.*bbM.^6.*((-1)+bbM.^2.*pM.^2).*(64+3.*bbM.^4.* ...
    j2.*((-16)+(-14).*bbM.^4.*j2+16.*bbM.^2.*pM.^2+(-7).*bbM.^6.*j2.* ...
    pM.^2+81.*bbM.^8.*j2.*pM.^4)).*cos(2.*tt)+8.*bbM.^6.*j2.*((-1)+ ...
    bbM.^2.*pM.^2).*(8+9.*bbM.^4.*j2.*((-4)+5.*bbM.^2.*pM.^2)).*xM.* ...
    cos(3.*tt)+6.*bbM.^10.*j2.*((-1)+bbM.^2.*pM.^2).*((-20)+29.* ...
    bbM.^4.*j2+44.*bbM.^2.*pM.^2+(-45).*bbM.^6.*j2.*pM.^2+16.*bbM.^8.* ...
    j2.*pM.^4).*cos(4.*tt)+12.*bbM.^10.*j2.^2.*(7+(-24).*bbM.^2.* ...
    pM.^2+17.*bbM.^4.*pM.^4).*xM.*cos(5.*tt)+3.*bbM.^14.*j2.^2.*((-28) ...
    +183.*bbM.^2.*pM.^2+(-318).*bbM.^4.*pM.^4+163.*bbM.^6.*pM.^6).* ...
    cos(6.*tt)+4.*((-32).*k.*R.*rho.*xM+3.*bbM.^6.*j2.*((-1)+bbM.^2.* ...
    pM.^2).*((-16)+(-25).*bbM.^4.*j2+65.*bbM.^6.*j2.*pM.^2).*yM).*sin( ...
    tt)+32.*bbM.^4.*k.*(14+(-11).*bbM.^2.*pM.^2).*R.*rho.*sin(2.*tt)+( ...
    -8).*bbM.^6.*j2.*((-1)+bbM.^2.*pM.^2).*((-8)+(-30).*bbM.^4.*j2+ ...
    75.*bbM.^6.*j2.*pM.^2).*yM.*sin(3.*tt)+12.*bbM.^10.*j2.^2.*(7+( ...
    -24).*bbM.^2.*pM.^2+17.*bbM.^4.*pM.^4).*yM.*sin(5.*tt));
  x = (-1/7680).*bbM.^(-2).*((-240).*bbM.^2.*(32+3.*bbM.^8.*j2.^2.* ...
    pi.^2.*(1+(-5).*bbM.^2.*pM.^2).^2).*xM+(-45).*bbM.^6.*((-64)+(-96) ...
    .*bbM.^4.*j2+192.*bbM.^6.*j2.*pM.^2+(-220).*bbM.^10.*j2.^2.*pM.^2+ ...
    (-2671).*bbM.^12.*j2.^2.*pM.^4+5490.*bbM.^14.*j2.^2.*pM.^6+ ...
    bbM.^8.*j2.*(281.*j2+672.*pM.^4)+32.*j2.^2.*(5.*xM.^2+(-7).*yM.^2) ...
    +32.*bbM.^2.*pM.^2.*(10+j2.^2.*((-3).*xM.^2+25.*yM.^2))).*cos(tt)+ ...
    (-60).*(3.*bbM.^6.*j2.*(64+(-82).*bbM.^4.*j2+(-1).*bbM.^2.*(32+ ...
    25.*bbM.^4.*j2).*pM.^2+299.*bbM.^8.*j2.*pM.^4).*xM+(-32).*k.*R.* ...
    rho.*yM).*cos(2.*tt)+15.*bbM.^6.*(688.*bbM.^4.*j2+(-2064).* ...
    bbM.^6.*j2.*pM.^2+2084.*bbM.^10.*j2.^2.*pM.^2+(-8621).*bbM.^12.* ...
    j2.^2.*pM.^4+6446.*bbM.^14.*j2.^2.*pM.^6+bbM.^8.*j2.*(91.*j2+ ...
    1376.*pM.^4)+(-16).*(28+j2.^2.*(15.*xM.^2+13.*yM.^2))+16.*bbM.^2.* ...
    pM.^2.*(28+j2.^2.*(11.*xM.^2+25.*yM.^2))).*cos(3.*tt)+90.*bbM.^6.* ...
    j2.*((-48)+127.*bbM.^4.*j2+6.*bbM.^2.*(8+(-73).*bbM.^4.*j2).* ...
    pM.^2+275.*bbM.^8.*j2.*pM.^4).*xM.*cos(4.*tt)+9.*bbM.^6.*j2.*((-1) ...
    +bbM.^2.*pM.^2).*((-80).*bbM.^4+161.*bbM.^8.*j2+640.*bbM.^6.* ...
    pM.^2+(-491).*bbM.^10.*j2.*pM.^2+1190.*bbM.^12.*j2.*pM.^4+80.*j2.* ...
    (xM+(-1).*yM).*(xM+yM)).*cos(5.*tt)+60.*bbM.^10.*j2.^2.*(14+(-137) ...
    .*bbM.^2.*pM.^2+123.*bbM.^4.*pM.^4).*xM.*cos(6.*tt)+45.*bbM.^14.* ...
    j2.^2.*((-3)+124.*bbM.^2.*pM.^2+(-323).*bbM.^4.*pM.^4+202.* ...
    bbM.^6.*pM.^6).*cos(7.*tt)+960.*j2.^(-1).*(2.*k.*(4+(-1).*bbM.^4.* ...
    j2+bbM.^6.*j2.*pM.^2).*R.*rho+3.*bbM.^6.*j2.^3.*(3+bbM.^2.*pM.^2) ...
    .*xM.*yM).*sin(tt)+60.*((-32).*k.*R.*rho.*xM+3.*bbM.^6.*j2.*(64+ ...
    46.*bbM.^4.*j2+(-1).*bbM.^2.*(128+467.*bbM.^4.*j2).*pM.^2+373.* ...
    bbM.^8.*j2.*pM.^4).*yM).*sin(2.*tt)+(-160).*bbM.^4.*(28.*k.*((-1)+ ...
    bbM.^2.*pM.^2).*R.*rho+3.*bbM.^2.*j2.^2.*(1+7.*bbM.^2.*pM.^2).* ...
    xM.*yM).*sin(3.*tt)+(-90).*bbM.^6.*j2.*(48+(-43).*bbM.^4.*j2+2.* ...
    bbM.^2.*((-24)+5.*bbM.^4.*j2).*pM.^2+81.*bbM.^8.*j2.*pM.^4).*yM.* ...
    sin(4.*tt)+1440.*bbM.^6.*j2.^2.*((-1)+bbM.^2.*pM.^2).*xM.*yM.*sin( ...
    5.*tt)+60.*bbM.^10.*j2.^2.*(14+(-137).*bbM.^2.*pM.^2+123.*bbM.^4.* ...
    pM.^4).*yM.*sin(6.*tt));
  y = (1/7680).*bbM.^(-2).*j2.^(-1).*((-960).*(2.*k.*((-4)+(-1).* ...
    bbM.^4.*j2+bbM.^6.*j2.*pM.^2).*R.*rho+3.*bbM.^6.*j2.^3.*((-5)+13.* ...
    bbM.^2.*pM.^2).*xM.*yM).*cos(tt)+j2.*(240.*bbM.^2.*(32+3.*bbM.^8.* ...
    j2.^2.*pi.^2.*(1+(-5).*bbM.^2.*pM.^2).^2).*yM+60.*((-32).*k.*R.* ...
    rho.*xM+3.*bbM.^6.*j2.*(96+12.*bbM.^4.*j2+(-1).*bbM.^2.*(128+159.* ...
    bbM.^4.*j2).*pM.^2+51.*bbM.^8.*j2.*pM.^4).*yM).*cos(2.*tt)+(-160) ...
    .*bbM.^4.*((-1)+bbM.^2.*pM.^2).*(28.*k.*R.*rho+15.*bbM.^2.*j2.^2.* ...
    xM.*yM).*cos(3.*tt)+(-90).*bbM.^6.*j2.*(48+(-15).*bbM.^4.*j2+(-2) ...
    .*bbM.^2.*(24+41.*bbM.^4.*j2).*pM.^2+109.*bbM.^8.*j2.*pM.^4).*yM.* ...
    cos(4.*tt)+1440.*bbM.^6.*j2.^2.*((-1)+bbM.^2.*pM.^2).*xM.*yM.*cos( ...
    5.*tt)+60.*bbM.^10.*j2.^2.*(14+(-137).*bbM.^2.*pM.^2+123.*bbM.^4.* ...
    pM.^4).*yM.*cos(6.*tt)+45.*bbM.^6.*(160.*bbM.^4.*j2+(-1024).* ...
    bbM.^6.*j2.*pM.^2+(-228).*bbM.^10.*j2.^2.*pM.^2+(-2921).*bbM.^12.* ...
    j2.^2.*pM.^4+5662.*bbM.^14.*j2.^2.*pM.^6+bbM.^8.*j2.*(367.*j2+ ...
    1632.*pM.^4)+32.*((-6)+j2.^2.*(xM.^2+(-7).*yM.^2))+32.*bbM.^2.* ...
    pM.^2.*(14+9.*j2.^2.*(xM.^2+yM.^2))).*sin(tt)+60.*(3.*bbM.^6.*j2.* ...
    (32+8.*bbM.^4.*j2+(-1).*bbM.^2.*(32+493.*bbM.^4.*j2).*pM.^2+725.* ...
    bbM.^8.*j2.*pM.^4).*xM+(-32).*k.*R.*rho.*yM).*sin(2.*tt)+(-15).* ...
    bbM.^6.*(592.*bbM.^4.*j2+(-1584).*bbM.^6.*j2.*pM.^2+948.*bbM.^10.* ...
    j2.^2.*pM.^2+(-5353).*bbM.^12.*j2.^2.*pM.^4+4118.*bbM.^14.*j2.^2.* ...
    pM.^6+bbM.^8.*j2.*(287.*j2+992.*pM.^4)+(-16).*(28+j2.^2.*(9.* ...
    xM.^2+19.*yM.^2))+16.*bbM.^2.*pM.^2.*(28+j2.^2.*(13.*xM.^2+23.* ...
    yM.^2))).*sin(3.*tt)+(-90).*bbM.^6.*j2.*((-1)+bbM.^2.*pM.^2).*(48+ ...
    (-99).*bbM.^4.*j2+247.*bbM.^6.*j2.*pM.^2).*xM.*sin(4.*tt)+(-9).* ...
    bbM.^6.*j2.*((-1)+bbM.^2.*pM.^2).*((-80).*bbM.^4+91.*bbM.^8.*j2+ ...
    640.*bbM.^6.*pM.^2+279.*bbM.^10.*j2.*pM.^2+130.*bbM.^12.*j2.* ...
    pM.^4+80.*j2.*(xM+(-1).*yM).*(xM+yM)).*sin(5.*tt)+(-60).*bbM.^10.* ...
    j2.^2.*(14+(-137).*bbM.^2.*pM.^2+123.*bbM.^4.*pM.^4).*xM.*sin(6.* ...
    tt)+(-45).*bbM.^14.*j2.^2.*((-3)+124.*bbM.^2.*pM.^2+(-323).* ...
    bbM.^4.*pM.^4+202.*bbM.^6.*pM.^6).*sin(7.*tt)));
  p = pM+(-1/8).*bbM.^(-2).*j2.*k.*pM.*R.*rho.*((-4).*xM.*sin(tt)+cos( ...
    tt).*(4.*yM+(bbM.^4+5.*bbM.^6.*pM.^2).*sin(tt)));
  oo = (1/128).*(64.*(2.*ooM+bbM.^3.*j2.*k.*pi.^2.*pM.*R.*rho)+bbM.^3.* ...
    j2.*pM.*(192.*k.*R.*rho.*cos(2.*tt)+bbM.^2.*(96.*sin(2.*tt)+j2.*( ...
    6.*(48+215.*bbM.^4.*j2+(-407).*bbM.^6.*j2.*pM.^2).*yM.*cos(tt)+4.* ...
    ((-8)+(-65).*bbM.^4.*j2+122.*bbM.^6.*j2.*pM.^2).*yM.*cos(3.*tt)+ ...
    6.*bbM.^4.*j2.*(7+(-13).*bbM.^2.*pM.^2).*yM.*cos(5.*tt)+6.*((-16)+ ...
    37.*bbM.^4.*j2+11.*bbM.^6.*j2.*pM.^2).*xM.*sin(tt)+3.*bbM.^4.*(56+ ...
    (-53).*bbM.^4.*j2+(-1).*bbM.^2.*(104+249.*bbM.^4.*j2).*pM.^2+428.* ...
    bbM.^8.*j2.*pM.^4).*sin(2.*tt)+(-4).*((-8)+bbM.^4.*j2+38.*bbM.^6.* ...
    j2.*pM.^2).*xM.*sin(3.*tt)+(-3).*bbM.^4.*(20+13.*bbM.^4.*j2+(-4).* ...
    bbM.^2.*(8+39.*bbM.^4.*j2).*pM.^2+161.*bbM.^8.*j2.*pM.^4).*sin(4.* ...
    tt)+6.*bbM.^4.*j2.*((-7)+13.*bbM.^2.*pM.^2).*xM.*sin(5.*tt)+3.* ...
    bbM.^8.*j2.*(14+(-61).*bbM.^2.*pM.^2+53.*bbM.^4.*pM.^4).*sin(6.* ...
    tt)))));
  t = (1/16).*bbM.^(-5).*k.*mu.^(-1/2).*(4.*pi.^2+bbM.^4.*j2.*(48+pi.^2+ ...
    (-1).*bbM.^2.*(144+7.*pi.^2).*pM.^2)).*R.^(5/2).*rho+tM+(1/7680).* ...
    bbM.^(-5).*j2.*mu.^(-1/2).*R.^(3/2).*(480.*((-16).*k.*R.*rho.*xM+ ...
    bbM.^2.*yM.*(32+3.*j2.*(24.*bbM.^4+bbM.^8.*j2.*(33+pi.^2)+(-72).* ...
    bbM.^6.*pM.^2+(-10).*bbM.^10.*j2.*(6+pi.^2).*pM.^2+bbM.^12.*j2.*(( ...
    -93)+25.*pi.^2).*pM.^4+16.*j2.*(xM.^2+yM.^2)))).*cos(tt)+(-80).* ...
    bbM.^2.*(bbM.^2.*k.*(17+(-107).*bbM.^2.*pM.^2).*R.*rho+12.*j2.*( ...
    12+7.*bbM.^4.*j2+21.*bbM.^6.*j2.*pM.^2).*xM.*yM).*cos(2.*tt)+(-20) ...
    .*bbM.^2.*j2.*yM.*(48.*bbM.^4+69.*bbM.^8.*j2+(-240).*bbM.^6.* ...
    pM.^2+(-648).*bbM.^10.*j2.*pM.^2+1029.*bbM.^12.*j2.*pM.^4+128.* ...
    j2.*((-3).*xM.^2+yM.^2)).*cos(3.*tt)+480.*bbM.^6.*j2.^2.*(3+(-13) ...
    .*bbM.^2.*pM.^2).*xM.*yM.*cos(4.*tt)+120.*bbM.^10.*j2.^2.*(2+(-23) ...
    .*bbM.^2.*pM.^2+30.*bbM.^4.*pM.^4).*yM.*cos(5.*tt)+(-480).*(16.* ...
    k.*R.*rho.*yM+bbM.^2.*xM.*(32+3.*j2.*(16.*bbM.^4+bbM.^8.*j2.*(20+ ...
    pi.^2)+(-64).*bbM.^6.*pM.^2+(-2).*bbM.^10.*j2.*(18+5.*pi.^2).* ...
    pM.^2+bbM.^12.*j2.*((-68)+25.*pi.^2).*pM.^4+16.*j2.*(xM.^2+yM.^2)) ...
    )).*sin(tt)+15.*bbM.^2.*(16.*bbM.^8.*j2+1152.*bbM.^10.*j2.*pM.^2+ ...
    70.*bbM.^14.*j2.^2.*pM.^2+(-5247).*bbM.^16.*j2.^2.*pM.^4+7448.* ...
    bbM.^18.*j2.^2.*pM.^6+bbM.^12.*j2.*(105.*j2+(-2896).*pM.^4)+384.* ...
    j2.*(xM+(-1).*yM).*(xM+yM)+112.*bbM.^6.*pM.^2.*(4+j2.^2.*(9.* ...
    xM.^2+(-3).*yM.^2))+(-16).*bbM.^4.*(4+j2.^2.*(3.*xM.^2+31.*yM.^2)) ...
    ).*sin(2.*tt)+20.*bbM.^2.*j2.*xM.*(48.*bbM.^4+81.*bbM.^8.*j2+( ...
    -240).*bbM.^6.*pM.^2+(-1068).*bbM.^10.*j2.*pM.^2+1545.*bbM.^12.* ...
    j2.*pM.^4+(-128).*j2.*(xM.^2+(-3).*yM.^2)).*sin(3.*tt)+(-3).* ...
    bbM.^6.*j2.*((-120).*bbM.^4+2040.*bbM.^6.*pM.^2+3752.*bbM.^10.* ...
    j2.*pM.^2+(-21001).*bbM.^12.*j2.*pM.^4+20430.*bbM.^14.*j2.*pM.^6+ ...
    bbM.^8.*(59.*j2+(-2640).*pM.^4)+240.*j2.*(xM+(-1).*yM).*(xM+yM)+( ...
    -1040).*bbM.^2.*j2.*pM.^2.*(xM+(-1).*yM).*(xM+yM)).*sin(4.*tt)+( ...
    -120).*bbM.^10.*j2.^2.*(2+(-23).*bbM.^2.*pM.^2+30.*bbM.^4.*pM.^4) ...
    .*xM.*sin(5.*tt)+5.*bbM.^14.*j2.^2.*((-35)+1104.*bbM.^2.*pM.^2+( ...
    -3615).*bbM.^4.*pM.^4+2762.*bbM.^6.*pM.^6).*sin(6.*tt));

  % Concatenate the elements of the osculating state
  osculatingState = [bb; x; y; p; oo; t];

end
