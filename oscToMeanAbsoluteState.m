%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% This script uses the nomenclature, formulations and solutions from:
%   M. Avillez and D. Arnas, "Osculating and Mean Asynchronous Relative Motion Approximations 
%   Under J2 and Atmospheric Drag", TODO
%
% Summary:
%   Converts an osculating absolute state to an mean absolute state.
%   Implements the solution from section V.A of the paper.
%
% Inputs:
%   tt: argument of latitude at which to compute the mean absolute state
%   mu: gravitational parameter
%   j2: J2 coefficient of the gravity model
%   R: Radius of the central planet
%   osculatingState: Osculating absolute state of the satellite -> see Note 1
%   k: Ballistic parameter of the satellite
%   rho: Atmospheric density acting on the satellite
%   expansionOrder: Order of the expansion to use (2 or 3)
%
% Outputs:
%   meanState: Mean absolute state -> see Note 1
%
% Note 1:
%   Mean absolute states: [bbM; xM; yM; pM; ooM; tM]
%   Osculating absolute states: [bb; x; y; p; oo; t]
%
% Authors: Miguel Avillez and David Arnas
% Created: August 2025
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function meanState = oscToMeanAbsoluteState(tt, mu, j2, R, osculatingState, k, rho, expansionOrder)

  if expansionOrder == 2
    meanState = oscToMeanAbsoluteStateOrder2(tt, mu, j2, R, osculatingState, k, rho);
  elseif expansionOrder == 3
    meanState = oscToMeanAbsoluteStateOrder3(tt, mu, j2, R, osculatingState, k, rho);
  else
    error("Invalid expansion order")
  end

end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Function: oscToMeanAbsoluteStateOrder2
%
% Summary:
%   Converts an osculating absolute state to an mean absolute state, based on a 2nd order expansion.
%
% Inputs:
%   tt: argument of latitude at which to compute the mean absolute state
%   mu: gravitational parameter
%   j2: J2 coefficient of the gravity model
%   R: Radius of the central planet
%   osculatingState: Osculating absolute state of the satellite -> see Note 1
%   k: Ballistic parameter of the satellite
%   rho: Atmospheric density acting on the satellite
%
% Outputs:
%   meanState: Mean absolute state -> see Note 1
%
% Note 1:
%   Mean absolute states: [bbM; xM; yM; pM; ooM; tM]
%   Osculating absolute states: [bb; x; y; p; oo; t]
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function meanState = oscToMeanAbsoluteStateOrder2(tt, mu, j2, R, osculatingState, k, rho)

  % Extract individual elements of the mean state
  bb = osculatingState(1);
  x = osculatingState(2);
  y = osculatingState(3);
  p = osculatingState(4);
  oo = osculatingState(5);
  t = osculatingState(6);

  % Compute mean elements
  bbM = (1/32).*bb.*(32+bb.^8.*j2.^2.*(29+(-76).*bb.^2.*p.^2+47.*bb.^4.* ...
    p.^4)+2.*bb.^4.*j2.*((-1)+bb.^2.*p.^2).*((-16).*j2.*x.*cos(tt).^3+ ...
    3.*((-4)+(-1).*bb.^4.*j2+9.*bb.^6.*j2.*p.^2).*cos(2.*tt)+3.* ...
    bb.^4.*j2.*((-1)+bb.^2.*p.^2).*cos(4.*tt)+16.*j2.*y.*sin(tt).^3)); ...
  xM = x+(3/128).*bb.^4.*(16+37.*bb.^4.*j2+(-2).*bb.^2.*(40+101.*bb.^4.* ...
    j2).*p.^2+45.*bb.^8.*j2.*p.^4).*cos(tt)+bb.^(-2).*j2.^(-1).*k.*R.* ...
    rho.*sin(tt)+(1/128).*bb.^4.*(96.*j2.*((-2)+bb.^2.*p.^2).*x.*cos( ...
    2.*tt)+2.*((-56)+23.*bb.^4.*j2+56.*bb.^2.*p.^2+(-123).*bb.^6.*j2.* ...
    p.^2+64.*bb.^8.*j2.*p.^4).*cos(3.*tt)+3.*j2.*((-1)+bb.^2.*p.^2).*( ...
    24.*x.*cos(4.*tt)+bb.^4.*((-13)+27.*bb.^2.*p.^2).*cos(5.*tt))+48.* ...
    j2.*y.*(4+(-8).*bb.^2.*p.^2+3.*((-1)+bb.^2.*p.^2).*cos(2.*tt)).* ...
    sin(2.*tt));
  yM = y+(-1).*bb.^(-2).*j2.^(-1).*k.*R.*rho.*cos(tt)+(1/128).*bb.^4.*(( ...
    -72).*j2.*((-1)+bb.^2.*p.^2).*y.*cos(4.*tt)+(-4).*((-8)+11.* ...
    bb.^4.*j2+8.*bb.^2.*(7+(-24).*bb.^4.*j2).*p.^2+325.*bb.^8.*j2.* ...
    p.^4).*sin(tt)+6.*j2.*((-1)+bb.^2.*p.^2).*(56.*x.*cos(tt)+24.*x.* ...
    cos(3.*tt)+bb.^4.*((-13)+27.*bb.^2.*p.^2).*cos(4.*tt)).*sin(tt)+ ...
    2.*cos(2.*tt).*(48.*j2.*((-3)+4.*bb.^2.*p.^2).*y+((-112)+169.* ...
    bb.^4.*j2+2.*bb.^2.*(56+(-285).*bb.^4.*j2).*p.^2+329.*bb.^8.*j2.* ...
    p.^4).*sin(tt)));
  pM = p;
  ooM = oo+(1/16).*bb.^5.*j2.*p.*((-12).*cos(tt).*(3.*j2.*y+2.*sin(tt))+ ...
    j2.*(4.*y.*cos(3.*tt)+16.*x.*sin(tt).^3+(-3).*bb.^4.*(7+(-21).* ...
    bb.^2.*p.^2+(2+bb.^2.*p.^2).*cos(2.*tt)).*sin(2.*tt)));
  tM = (-1/4).*bb.^(-5).*k.*mu.^(-1/2).*((-8)+pi.^2).*R.^(5/2).*rho+t+( ...
    1/64).*bb.^(-3).*j2.*mu.^(-1/2).*R.^(3/2).*(4.*((-32)+21.*bb.^4.* ...
    j2+51.*bb.^6.*j2.*p.^2).*y.*cos(tt)+96.*j2.*x.*y.*cos(2.*tt)+4.* ...
    bb.^4.*j2.*(23+(-19).*bb.^2.*p.^2).*y.*cos(3.*tt)+4.*(32+81.* ...
    bb.^4.*j2+(-177).*bb.^6.*j2.*p.^2).*x.*sin(tt)+6.*(12.*bb.^4+19.* ...
    bb.^8.*j2+(-20).*bb.^6.*p.^2+(-160).*bb.^10.*j2.*p.^2+193.* ...
    bb.^12.*j2.*p.^4+(-8).*j2.*x.^2+8.*j2.*y.^2).*sin(2.*tt)+4.* ...
    bb.^4.*j2.*((-23)+19.*bb.^2.*p.^2).*x.*sin(3.*tt)+(-3).*bb.^8.* ...
    j2.*(26+(-63).*bb.^2.*p.^2+43.*bb.^4.*p.^4).*sin(4.*tt));

  % Concatenate the elements of the mean state
  meanState = [bbM; xM; yM; pM; ooM; tM];

end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Function: oscToMeanAbsoluteStateOrder3
%
% Summary:
%   Converts an osculating absolute state to an mean absolute state, based on a 3rd order expansion.
%
% Inputs:
%   tt: argument of latitude at which to compute the mean absolute state
%   mu: gravitational parameter
%   j2: J2 coefficient of the gravity model
%   R: Radius of the central planet
%   osculatingState: Osculating absolute state of the satellite -> see Note 1
%   k: Ballistic parameter of the satellite
%   rho: Atmospheric density acting on the satellite
%
% Outputs:
%   meanState: Mean absolute state -> see Note 1
%
% Note 1:
%   Mean absolute states: [bbM; xM; yM; pM; ooM; tM]
%   Osculating absolute states: [bb; x; y; p; oo; t]
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function meanState = oscToMeanAbsoluteStateOrder3(tt, mu, j2, R, osculatingState, k, rho)

  % Extract individual elements of the mean state
  bb = osculatingState(1);
  x = osculatingState(2);
  y = osculatingState(3);
  p = osculatingState(4);
  oo = osculatingState(5);
  t = osculatingState(6);

  % Compute mean elements
  bbM = (1/256).*bb.^(-1).*(4.*bb.^2.*(64+(-1).*bb.^8.*j2.^2.*((-1)+bb.*p) ...
    .*(1+bb.*p).*(58+5.*bb.^4.*j2+(-1).*bb.^2.*(94+405.*bb.^4.*j2).* ...
    p.^2+544.*bb.^8.*j2.*p.^4))+j2.*(16.*(3.*bb.^6.*j2.*((-1)+bb.^2.* ...
    p.^2).*((-4)+(-7).*bb.^4.*j2+25.*bb.^6.*j2.*p.^2).*x+(-8).*k.*R.* ...
    rho.*y).*cos(tt)+(-3).*bb.^6.*((-1)+bb.^2.*p.^2).*(64+bb.^4.*j2.*( ...
    16+273.*bb.^4.*j2+(-2).*bb.^2.*(72+443.*bb.^4.*j2).*p.^2+829.* ...
    bb.^8.*j2.*p.^4)).*cos(2.*tt)+8.*bb.^6.*j2.*((-1)+bb.^2.*p.^2).*(( ...
    -8)+9.*bb.^4.*j2.*((-3)+7.*bb.^2.*p.^2)).*x.*cos(3.*tt)+(-6).* ...
    bb.^10.*j2.*((-1)+bb.^2.*p.^2).^2.*((-8)+9.*bb.^4.*j2.*((-3)+16.* ...
    bb.^2.*p.^2)).*cos(4.*tt)+24.*bb.^10.*j2.^2.*((-1)+bb.^2.*p.^2) ...
    .^2.*x.*cos(5.*tt)+21.*bb.^14.*j2.^2.*((-1)+bb.^2.*p.^2).^3.*cos( ...
    6.*tt)+16.*(8.*k.*R.*rho.*x+3.*bb.^6.*j2.*((-1)+bb.^2.*p.^2).*(4+( ...
    -9).*bb.^4.*j2+7.*bb.^6.*j2.*p.^2).*y).*sin(tt)+32.*bb.^4.*k.*(( ...
    -8)+5.*bb.^2.*p.^2).*R.*rho.*sin(2.*tt)+8.*bb.^6.*j2.*((-1)+ ...
    bb.^2.*p.^2).*((-8)+3.*bb.^4.*j2.*(5+7.*bb.^2.*p.^2)).*y.*sin(3.* ...
    tt)+24.*bb.^10.*j2.^2.*((-1)+bb.^2.*p.^2).^2.*y.*sin(5.*tt)));
  xM = (1/30720).*bb.^(-2).*((-120).*bb.^2.*((-256)+bb.^8.*j2.^2.*(135+( ...
    -86).*bb.^2.*p.^2+23.*bb.^4.*p.^4+24.*(1+(-5).*bb.^2.*p.^2).^2.* ...
    pi.^2)).*x+90.*bb.^6.*(128+296.*bb.^4.*j2+(-1616).*bb.^6.*j2.* ...
    p.^2+225.*bb.^12.*j2.^2.*p.^4.*(71+(-4).*pi.^2)+2.*bb.^10.*j2.^2.* ...
    p.^2.*((-3779)+90.*pi.^2)+bb.^14.*j2.^2.*p.^6.*((-12427)+1500.* ...
    pi.^2)+2.*bb.^8.*j2.*(180.*p.^4+j2.*(253+(-6).*pi.^2))+64.*j2.^2.* ...
    ((-5).*x.^2+7.*y.^2)+64.*bb.^2.*p.^2.*((-10)+j2.^2.*(3.*x.^2+(-25) ...
    .*y.^2))).*cos(tt)+(-240).*(3.*bb.^6.*j2.*(64+(-19).*bb.^4.*j2+( ...
    -1).*bb.^2.*(32+83.*bb.^4.*j2).*p.^2+198.*bb.^8.*j2.*p.^4).*x+( ...
    -32).*k.*R.*rho.*y).*cos(2.*tt)+(-15).*bb.^6.*((-736).*bb.^4.*j2+ ...
    3936.*bb.^6.*j2.*p.^2+5.*bb.^12.*j2.^2.*p.^4.*(5113+(-1176).* ...
    pi.^2)+7.*bb.^14.*j2.^2.*p.^6.*((-5491)+600.*pi.^2)+bb.^10.* ...
    j2.^2.*p.^2.*(10687+1848.*pi.^2)+(-1).*bb.^8.*j2.*(2927.*j2+2048.* ...
    p.^4+168.*j2.*pi.^2)+64.*(28+j2.^2.*(15.*x.^2+13.*y.^2))+(-64).* ...
    bb.^2.*p.^2.*(28+j2.^2.*(11.*x.^2+25.*y.^2))).*cos(3.*tt)+360.* ...
    bb.^6.*j2.*((-48)+71.*bb.^4.*j2+2.*bb.^2.*(24+(-95).*bb.^4.*j2).* ...
    p.^2+91.*bb.^8.*j2.*p.^4).*x.*cos(4.*tt)+(-9).*bb.^6.*j2.*((-1040) ...
    .*bb.^4+3200.*bb.^6.*p.^2+36187.*bb.^10.*j2.*p.^2+(-66831).* ...
    bb.^12.*j2.*p.^4+35235.*bb.^14.*j2.*p.^6+(-1).*bb.^8.*(3511.*j2+ ...
    2160.*p.^4)+320.*j2.*(x+(-1).*y).*(x+y)+320.*bb.^2.*j2.*p.^2.*(( ...
    -1).*x.^2+y.^2)).*cos(5.*tt)+240.*bb.^10.*j2.^2.*(43+(-127).* ...
    bb.^2.*p.^2+84.*bb.^4.*p.^4).*x.*cos(6.*tt)+90.*bb.^14.*j2.^2.*(( ...
    -22)+56.*bb.^2.*p.^2+(-109).*bb.^4.*p.^4+75.*bb.^6.*p.^6).*cos(7.* ...
    tt)+960.*j2.^(-1).*(k.*(32+3.*bb.^4.*j2+45.*bb.^6.*j2.*p.^2).*R.* ...
    rho+12.*bb.^6.*j2.^3.*(3+bb.^2.*p.^2).*x.*y).*sin(tt)+240.*((-32) ...
    .*k.*R.*rho.*x+3.*bb.^6.*j2.*(64+53.*bb.^4.*j2+(-1).*bb.^2.*(128+ ...
    493.*bb.^4.*j2).*p.^2+600.*bb.^8.*j2.*p.^4).*y).*sin(2.*tt)+(-320) ...
    .*bb.^4.*(k.*(97+(-133).*bb.^2.*p.^2).*R.*rho+6.*bb.^2.*j2.^2.*(1+ ...
    7.*bb.^2.*p.^2).*x.*y).*sin(3.*tt)+(-360).*bb.^6.*j2.*(48+69.* ...
    bb.^4.*j2+(-2).*bb.^2.*(24+107.*bb.^4.*j2).*p.^2+209.*bb.^8.*j2.* ...
    p.^4).*y.*sin(4.*tt)+5760.*bb.^6.*j2.^2.*((-1)+bb.^2.*p.^2).*x.* ...
    y.*sin(5.*tt)+240.*bb.^10.*j2.^2.*(43+(-127).*bb.^2.*p.^2+84.* ...
    bb.^4.*p.^4).*y.*sin(6.*tt));
  yM = (1/30720).*bb.^(-2).*j2.^(-1).*((-960).*(k.*(32+(-39).*bb.^4.*j2+ ...
    63.*bb.^6.*j2.*p.^2).*R.*rho+12.*bb.^6.*j2.^3.*(5+(-13).*bb.^2.* ...
    p.^2).*x.*y).*cos(tt)+j2.*((-120).*bb.^2.*((-256)+bb.^8.*j2.^2.*( ...
    367+(-2310).*bb.^2.*p.^2+2303.*bb.^4.*p.^4+24.*(1+(-5).*bb.^2.* ...
    p.^2).^2.*pi.^2)).*y+240.*(32.*k.*R.*rho.*x+(-3).*bb.^6.*j2.*(96+ ...
    17.*bb.^4.*j2+(-1).*bb.^2.*(128+117.*bb.^4.*j2).*p.^2+132.*bb.^8.* ...
    j2.*p.^4).*y).*cos(2.*tt)+320.*bb.^4.*(k.*(97+(-133).*bb.^2.*p.^2) ...
    .*R.*rho+30.*bb.^2.*j2.^2.*((-1)+bb.^2.*p.^2).*x.*y).*cos(3.*tt)+ ...
    360.*bb.^6.*j2.*(48+33.*bb.^4.*j2+(-6).*bb.^2.*(8+23.*bb.^4.*j2).* ...
    p.^2+157.*bb.^8.*j2.*p.^4).*y.*cos(4.*tt)+(-5760).*bb.^6.*j2.^2.*( ...
    (-1)+bb.^2.*p.^2).*x.*y.*cos(5.*tt)+(-240).*bb.^10.*j2.^2.*(43+( ...
    -127).*bb.^2.*p.^2+84.*bb.^4.*p.^4).*y.*cos(6.*tt)+90.*bb.^6.*( ...
    384+(-568).*bb.^4.*j2+3568.*bb.^6.*j2.*p.^2+174.*bb.^12.*j2.^2.* ...
    p.^4.*(127+(-10).*pi.^2)+3.*bb.^10.*j2.^2.*p.^2.*((-3489)+148.* ...
    pi.^2)+4.*bb.^14.*j2.^2.*p.^6.*((-4022)+525.*pi.^2)+bb.^8.*j2.*(( ...
    -4344).*p.^4+j2.*(1145+(-36).*pi.^2))+(-64).*j2.^2.*(x.^2+(-7).* ...
    y.^2)+(-64).*bb.^2.*p.^2.*(14+9.*j2.^2.*(x.^2+y.^2))).*sin(tt)+ ...
    240.*((-3).*bb.^6.*j2.*(32+17.*bb.^4.*j2+(-1).*bb.^2.*(32+435.* ...
    bb.^4.*j2).*p.^2+642.*bb.^8.*j2.*p.^4).*x+32.*k.*R.*rho.*y).*sin( ...
    2.*tt)+(-15).*bb.^6.*((-2080).*bb.^4.*j2+7200.*bb.^6.*j2.*p.^2+ ...
    bb.^12.*j2.^2.*p.^4.*(138317+(-5880).*pi.^2)+7.*bb.^14.*j2.^2.* ...
    p.^6.*((-13363)+600.*pi.^2)+bb.^10.*j2.^2.*p.^2.*((-55337)+1848.* ...
    pi.^2)+bb.^8.*j2.*(5881.*j2+(-3968).*p.^4+(-168).*j2.*pi.^2)+64.*( ...
    28+j2.^2.*(9.*x.^2+19.*y.^2))+(-64).*bb.^2.*p.^2.*(28+j2.^2.*(13.* ...
    x.^2+23.*y.^2))).*sin(3.*tt)+360.*bb.^6.*j2.*((-48)+107.*bb.^4.* ...
    j2+48.*bb.^2.*p.^2+(-266).*bb.^6.*j2.*p.^2+143.*bb.^8.*j2.*p.^4).* ...
    x.*sin(4.*tt)+(-9).*bb.^6.*j2.*((-1040).*bb.^4+3200.*bb.^6.*p.^2+ ...
    45187.*bb.^10.*j2.*p.^2+(-76911).*bb.^12.*j2.*p.^4+38895.*bb.^14.* ...
    j2.*p.^6+(-1).*bb.^8.*(6091.*j2+2160.*p.^4)+320.*j2.*(x+(-1).*y).* ...
    (x+y)+320.*bb.^2.*j2.*p.^2.*((-1).*x.^2+y.^2)).*sin(5.*tt)+240.* ...
    bb.^10.*j2.^2.*(43+(-127).*bb.^2.*p.^2+84.*bb.^4.*p.^4).*x.*sin( ...
    6.*tt)+90.*bb.^14.*j2.^2.*((-1)+bb.*p).*(1+bb.*p).*(22+(-34).* ...
    bb.^2.*p.^2+75.*bb.^4.*p.^4).*sin(7.*tt)));
  pM = p+(1/16).*bb.^(-2).*j2.*k.*p.*R.*rho.*(8.*y.*cos(tt)+(-8).*x.*sin( ...
    tt)+3.*bb.^4.*((-1)+3.*bb.^2.*p.^2).*sin(2.*tt));
  ooM = oo+(-1/2).*bb.^3.*j2.*k.*p.*((-3)+pi.^2).*R.*rho+(9/8).*bb.^5.* ...
    j2.^2.*p.*((-2)+(-9).*bb.^4.*j2+16.*bb.^6.*j2.*p.^2).*y.*cos(tt)+( ...
    -1).*bb.^3.*j2.*k.*p.*R.*rho.*cos(2.*tt)+(1/256).*bb.^5.*j2.*p.*( ...
    64.*j2.*x.*(4+(-14).*bb.^4.*j2+8.*bb.^6.*j2.*p.^2+3.*bb.^4.*j2.*( ...
    1+bb.^2.*p.^2).*cos(2.*tt)).*sin(tt).^3+6.*bb.^4.*j2.^2.*cos(5.* ...
    tt).*(4.*(1+bb.^2.*p.^2).*y+bb.^4.*(7+(-29).*bb.^2.*p.^2+10.* ...
    bb.^4.*p.^4).*sin(tt))+2.*j2.*cos(3.*tt).*(4.*(8+(-79).*bb.^4.*j2+ ...
    13.*bb.^6.*j2.*p.^2).*y+(-3).*bb.^4.*(16+(-33).*bb.^4.*j2+8.* ...
    bb.^2.*p.^2+(-363).*bb.^6.*j2.*p.^2+276.*bb.^8.*j2.*p.^4).*sin(tt) ...
    )+(-6).*(32+bb.^4.*j2.*(64+92.*bb.^4.*j2+(-1).*bb.^2.*(164+947.* ...
    bb.^4.*j2).*p.^2+1017.*bb.^8.*j2.*p.^4)).*sin(2.*tt));
  tM = (1/6144).*bb.^(-5).*mu.^(-1/2).*(384.*(k.*((-4).*((-8)+pi.^2)+(-1) ...
    .*bb.^4.*j2.*(12+pi.^2)+bb.^6.*j2.*p.^2.*(12+7.*pi.^2)).*R.^(5/2) ...
    .*rho+bb.^5.*(16.*mu.^(1/2).*t+bb.*j2.^3.*(85+(-91).*bb.^2.*p.^2) ...
    .*R.^(3/2).*x.*y))+j2.*R.^(3/2).*((-48).*(bb.^2.*(256+(-3).* ...
    bb.^4.*j2.*(56+121.*bb.^4.*j2+4.*bb.^2.*(34+(-411).*bb.^4.*j2).* ...
    p.^2+2243.*bb.^8.*j2.*p.^4)).*y+128.*(k.*R.*rho.*x+3.*bb.^2.* ...
    j2.^2.*y.*(x.^2+y.^2))).*cos(tt)+192.*bb.^2.*(bb.^2.*k.*(bb.^2.* ...
    p.^2.*(191+(-30).*pi.^2)+5.*((-41)+6.*pi.^2)).*R.*rho+12.*j2.*(4+( ...
    -11).*bb.^4.*j2+39.*bb.^6.*j2.*p.^2).*x.*y).*cos(2.*tt)+(-64).* ...
    bb.^2.*j2.*y.*(3.*bb.^4.*((-46)+147.*bb.^4.*j2+38.*bb.^2.*p.^2+( ...
    -562).*bb.^6.*j2.*p.^2+607.*bb.^8.*j2.*p.^4)+96.*j2.*x.^2+(-32).* ...
    j2.*y.^2).*cos(3.*tt)+(-27648).*bb.^6.*j2.^2.*((-1)+bb.^2.*p.^2).* ...
    x.*y.*cos(4.*tt)+144.*bb.^10.*j2.^2.*(27+(-112).*bb.^2.*p.^2+93.* ...
    bb.^4.*p.^4).*y.*cos(5.*tt)+48.*((-128).*k.*R.*rho.*y+bb.^2.*x.*( ...
    256+3.*j2.*(216.*bb.^4+523.*bb.^8.*j2+(-472).*bb.^6.*p.^2+(-2524) ...
    .*bb.^10.*j2.*p.^2+2305.*bb.^12.*j2.*p.^4+128.*j2.*(x.^2+y.^2)))) ...
    .*sin(tt)+(-9).*bb.^2.*((-1216).*bb.^8.*j2+10240.*bb.^10.*j2.* ...
    p.^2+33041.*bb.^14.*j2.^2.*p.^2+(-110227).*bb.^16.*j2.^2.*p.^4+ ...
    95975.*bb.^18.*j2.^2.*p.^6+(-1).*bb.^12.*j2.*(2853.*j2+12352.* ...
    p.^4)+512.*j2.*(x+(-1).*y).*(x+y)+256.*bb.^6.*p.^2.*(5+3.*j2.^2.*( ...
    9.*x.^2+(-4).*y.^2))+(-256).*bb.^4.*(3+j2.^2.*(10.*x.^2+(-1).* ...
    y.^2))).*sin(2.*tt)+64.*bb.^2.*j2.*x.*((-138).*bb.^4+(-519).* ...
    bb.^8.*j2+114.*bb.^6.*p.^2+522.*bb.^10.*j2.*p.^2+465.*bb.^12.*j2.* ...
    p.^4+32.*j2.*(x.^2+(-3).*y.^2)).*sin(3.*tt)+36.*bb.^6.*j2.*((-208) ...
    .*bb.^4+504.*bb.^6.*p.^2+2687.*bb.^10.*j2.*p.^2+(-4342).*bb.^12.* ...
    j2.*p.^4+2499.*bb.^14.*j2.*p.^6+(-4).*bb.^8.*(109.*j2+86.*p.^4)+ ...
    384.*bb.^2.*j2.*p.^2.*(x+(-1).*y).*(x+y)+384.*j2.*((-1).*x.^2+ ...
    y.^2)).*sin(4.*tt)+(-144).*bb.^10.*j2.^2.*(27+(-112).*bb.^2.*p.^2+ ...
    93.*bb.^4.*p.^4).*x.*sin(5.*tt)+3.*bb.^14.*j2.^2.*(2371+(-8247).* ...
    bb.^2.*p.^2+9525.*bb.^4.*p.^4+(-3937).*bb.^6.*p.^6).*sin(6.*tt)));

  % Concatenate the elements of the mean state
  meanState = [bbM; xM; yM; pM; ooM; tM];

end

